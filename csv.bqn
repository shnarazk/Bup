# Comma-separated values (.csv)
# copied from https://github.com/mlochbaum/bqn-libs/blob/master/csv.bqn
# modified to accept empty fields:
#   - the original returns `‚ü®"1","3"‚ü©`       for `"1,,3,"`
#   - this version returns `‚ü®"1",‚ü®),"3",‚ü®)‚ü©` for `"1,,3,"`
‚ü®
  Split , Join   # Convert between plain text and split cells
  SplitL, JoinL  # Between list of lines and split cells
  ParseFile
‚ü©‚áê

# Control characters: double quote, comma, newline
control ‚Üê {
  0=‚â†‚Ä¢args ? ""","‚àæ@+10 ;
  ("CSV: ‚Ä¢args must consist of 3 values" ! ‚ü®3‚ü©‚â°‚â¢)‚ä∏‚ä¢ ‚àæ‚çü(1<‚â°) ‚Ä¢args
}

# Join by separator ùï®
J ‚Üê ‚àæ1‚Üì¬∑‚•ä<‚ä∏(‚âçÀò)

# CSV text to list of list of strings
Split ‚Üê { ùïä‚Åºùï©: Joinùï© ;
  [q,c,n] ‚Üê control=‚åúùï©
  e ‚Üê ‚â†`q       # Escaped characters
  s ‚Üê e<c‚à®n     # Split points
  d ‚Üê s‚à®q>¬ªe<q  # Characters to be dropped
  (0‚àæs/+`e<n) ‚äî (d(¬¨‚ä∏√ó-‚ä£)+`s) ‚äî ùï©
}

# Parse list of lines, e.g. from ‚Ä¢file.Lines
SplitL ‚Üê { ùïä‚Åºùï©: JoinLùï© ; Split (2‚äëcontrol) J ùï© }

# List of list of strings, or table, to list of lines
# Result contains internal line separators if ùï© does
JoinL ‚Üê { ùïä‚Åºùï©: SplitLùï© ;
  q‚Äøc‚Äøn ‚Üê control
  ùï© <Àò‚çü(1<=)‚Ü©
  Esc ‚Üê (q‚àæÀúq‚àæ(1+q‚ä∏=)‚ä∏/)‚çü(‚à®¬¥control‚ä∏‚àä)
  (c J Esc¬®)¬® ùï©
}

# To CSV text
Join ‚Üê { ùïä‚Åºùï©: Splitùï© ; (2‚äëcontrol) J JoinL ùï© }

NoValueField ‚Üê (‚ü®1,1‚ü©‚ä∏‚â°)¬®‚àò<Àò2‚Üï¬∑(','‚ä∏‚â°)¬®(','‚ä∏(‚àæÀú))
ParseFile ‚Üê {
 ((@‚ä∏‚â†)¬®‚ä∏/)¬®¬®Àò¬∑SplitL (‚àæNoValueField‚ä∏({ùï® ? ‚ü®',',@‚ü©;‚ü®ùï©‚ü©}¬®))¬® ('#'‚ä∏‚â¢‚äë)¬®‚ä∏/‚Ä¢Flines ùï©;
 ((@‚ä∏‚â¢)¬®‚ä∏/)¬®¬®Àò¬∑SplitL (‚àæNoValueField‚ä∏({ùï® ? ‚ü®',',@‚ü©;‚ü®ùï©‚ü©}¬®))¬® ùï®‚Üì('#'‚ä∏‚â¢‚äë)¬®‚ä∏/‚Ä¢Flines ùï©
}
