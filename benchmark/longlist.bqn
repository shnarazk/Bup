#!/usr/bin/env cbqn
env â† {vâ‡â‰>âŠ‘âˆ˜âŠâŸœ'='âŠ¸(â†‘â‹ˆ1â†“â†“)Â¨{-Â¬(Â¬Ã—1++`)ğ•©=@+10}âŠ¸âŠ”1âŠ‘â€¢SH<"env",Varâ‡{âŠâŸœğ•©âŠ¸âŠâŸœ(âˆ¾âŸœ@)Ëv}}
util â† â€¢Import "/util.bqn"âˆ¾Ëœâˆ¾env.Varâ‹ˆ"BQN_LIB"

# Since BQN uses immutable data structures, in-place updating
# is crucial. But it's not impossible in some case.
# A solution is passing namespace intead of passing object itself
# as an argument.
LongList â‡ {
    segment â† ğ•©
    vec â‡ âŸ¨âŸ¨âŸ©âŸ©
    Get â‡ {ğ•Š ğ•© : c â† ğ•©âŒŠâˆ˜Ã·segment â‹„ (segment|ğ•©)âŠ‘câŠ‘vec}
    Add â‡ { segment=â‰ Â¯1âŠ‘vec ? vec âˆ¾âŸœâŸ¨ğ•©âŸ© â†© ; vec âˆ¾âŸœğ•©âŒ¾(Â¯1âŠ¸âŠ‘) â†© }
    Size â‡ {ğ•¤ â‹„ +Â´â‰ Â¨vec}
    Tail â‡ {
      ğ•Š n : nâ‰¤Size@ ? (-n){ (-ğ•¨)â‰¤â‰ ğ•© ? ğ•¨â†‘ğ•© ; ğ•¨â†‘âˆ¾âŸœğ•© Â¯2âŠ‘vec}Â¯1âŠ‘vec ;
      ğ•Š n : âˆ¾vec
    }
  }

"init/add" util.Debug start_lengthâ€¿updates â† 1e6â€¿1e4

!âŸœ(start_lengthâŠ¸â‰¡) â‰ l â† start_lengthâ†‘Ï€
"update lst" util.Debug {{câ€¿m : l â†© lâˆ¾Ï€ â‹„ âŸ¨c+1,mâŸ©}â€¢_while_(ğ•©>âŠ‘)0â€¿âŸ¨âŸ©}â€¢_timed updates
l â†© start_lengthâ†‘Ï€
"in-place -" util.Debug {{câ€¿m : l âˆ¾âŸœÏ€ â†© â‹„ âŸ¨c+1,mâŸ©}â€¢_while_(ğ•©>âŠ‘)0â€¿âŸ¨âŸ©}â€¢_timed updates
l â†© start_lengthâ†‘Ï€
"update arg" util.Debug {l â†© 1âŠ‘{câ€¿l : l â†© lâˆ¾Ï€ â‹„ âŸ¨c+1,lâŸ©}â€¢_while_(ğ•©>âŠ‘)0â€¿l} â€¢_timed updates
l â†© start_lengthâ†‘Ï€
"in-place -" util.Debug {l â†© 1âŠ‘{câ€¿l : l âˆ¾âŸœÏ€ â†© â‹„ âŸ¨c+1,lâŸ©}â€¢_while_(ğ•©>âŠ‘)0â€¿l} â€¢_timed updates
l â†© start_lengthâ†‘Ï€
"in-place 2" util.Debug {l â†© 1âŠ‘{câ€¿l : âŸ¨c+1,lâˆ¾Ï€âŸ©}â€¢_while_(ğ•©>âŠ‘)0â€¿l} â€¢_timed updates

m â† Longlist 100000
{m.Add Ï€ â‹„ ğ•©+1}â€¢_while_(start_lengthâŠ¸>)0
!âŸœ(start_lengthâŠ¸â‰¡) m.Size@
"indirect -" util.Debug {m â†© 1âŠ‘{câ€¿m : m.Add Ï€ â‹„ âŸ¨c+1,mâŸ©}â€¢_while_(ğ•©>âŠ‘)0â€¿m} â€¢_timed updates

!âŸœ((start_length+updates)âŠ¸â‰¡) â‰ l
!âŸœ((start_length+updates)âŠ¸â‰¡) m.Size@

#  - init/add:   âŸ¨ 1000000 10000 âŸ©
#  - update lst: 6.625975
#  - in-place -: 0.001391
#  - update arg: 6.722821000000001
#  - in-place -: 6.660316000000001
#  - in-place 2: 6.640160000000001
#  - indirect -: 0.0028940000000000003

