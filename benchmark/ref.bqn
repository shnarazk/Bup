#!/usr/bin/env cbqn
env â† {vâ‡â‰>âŠ‘âˆ˜âŠâŸœ'='âŠ¸(â†‘â‹ˆ1â†“â†“)Â¨{-Â¬(Â¬Ã—1++`)ğ•©=@+10}âŠ¸âŠ”1âŠ‘â€¢SH<"env",Varâ‡{âŠâŸœğ•©âŠ¸âŠâŸœ(âˆ¾âŸœ@)Ëv}}
util â† â€¢Import "/util.bqn"âˆ¾Ëœenv.VarâŒ¾â‹ˆ"BQN_LIB"

# Since BQN uses immutable data structures, in-place updating
# is crucial. But it's not impossible in some case.
# A solution is passing namespace intead of passing object itself
# as an argument.
LongList â‡ {
  segment â† ğ•©
  vec â‡ âŸ¨âŸ¨âŸ©âŸ©
  Get â‡ {ğ•Š ğ•© : c â† ğ•©âŒŠâˆ˜Ã·segment â‹„ (segment|ğ•©)âŠ‘câŠ‘vec}
  Add â‡ { segment=â‰ Â¯1âŠ‘vec ? vec âˆ¾âŸœâŸ¨ğ•©âŸ© â†© ; vec âˆ¾âŸœğ•©âŒ¾(Â¯1âŠ¸âŠ‘) â†© }
  Size â‡ {ğ•¤ â‹„ +Â´â‰ Â¨vec}
  Tail â‡ {
    ğ•Š n : nâ‰¤Size@ ? (-n){ (-ğ•¨)â‰¤â‰ ğ•© ? ğ•¨â†‘ğ•© ; ğ•¨â†‘âˆ¾âŸœğ•© Â¯2âŠ‘vec}Â¯1âŠ‘vec ;
    ğ•Š n : âˆ¾vec
  }
}

Ref â‡ {
  ref â‡ ğ•©
  Set â‡ {ref â†© ğ•© }
  Append â‡ {ref âˆ¾âŸœğ•© â†© }
  Preppend â‡ {ref ğ•©âŠ¸âˆ¾ â†© }
  Update1 â‡ {f â† âŠ‘ğ•© â‹„ ref F â†© }
  _update2 â‡ {ref ğ”½ â†© }
  _update3 â‡ {ref ğ”½ â†© ğ•©}
}

"init/add" util.Debug start_lengthâ€¿updates â† 1e6â€¿1e4

!âŸœ(start_lengthâŠ¸â‰¡) â‰ l â† start_lengthâ†‘Ï€
"update lst" util.Debug {{câ€¿m : l â†© lâˆ¾Ï€ â‹„ âŸ¨c+1,mâŸ©}â€¢_while_(ğ•©>âŠ‘)0â€¿âŸ¨âŸ©}â€¢_timed updates
!âŸœ((start_length+updates)âŠ¸â‰¡) â‰ l
l â†© start_lengthâ†‘Ï€
"in-place -" util.Debug {{câ€¿m : l âˆ¾âŸœÏ€ â†© â‹„ âŸ¨c+1,mâŸ©}â€¢_while_(ğ•©>âŠ‘)0â€¿âŸ¨âŸ©}â€¢_timed updates
!âŸœ((start_length+updates)âŠ¸â‰¡) â‰ l
l â†© start_lengthâ†‘Ï€
"update arg" util.Debug {l â†© 1âŠ‘{câ€¿l : l â†© lâˆ¾Ï€ â‹„ âŸ¨c+1,lâŸ©}â€¢_while_(ğ•©>âŠ‘)0â€¿l} â€¢_timed updates
!âŸœ((start_length+updates)âŠ¸â‰¡) â‰ l
l â†© start_lengthâ†‘Ï€
"in-place -" util.Debug {l â†© 1âŠ‘{câ€¿l : l âˆ¾âŸœÏ€ â†© â‹„ âŸ¨c+1,lâŸ©}â€¢_while_(ğ•©>âŠ‘)0â€¿l} â€¢_timed updates
!âŸœ((start_length+updates)âŠ¸â‰¡) â‰ l
l â†© start_lengthâ†‘Ï€
"in-place 2" util.Debug {l â†© 1âŠ‘{câ€¿l : âŸ¨c+1,lâˆ¾Ï€âŸ©}â€¢_while_(ğ•©>âŠ‘)0â€¿l} â€¢_timed updates
!âŸœ((start_length+updates)âŠ¸â‰¡) â‰ l

l â†© start_lengthâ†‘Ï€
"Ref.append" util.Debug {l â†© {ğ•©.ref}1âŠ‘{câ€¿w : w.Append Ï€ â‹„ âŸ¨c+1,wâŸ©}â€¢_while_(ğ•©>âŠ‘)âŸ¨0,Ref lâŸ©} â€¢_timed updates
!âŸœ((start_length+updates)âŠ¸â‰¡) â‰ l

l â†© start_lengthâ†‘Ï€
"-.update1" util.Debug {l â†© {ğ•©.ref}1âŠ‘{câ€¿w : w.Update1âŸ¨âˆ¾âŸœÏ€âŸ© â‹„ âŸ¨c+1,wâŸ©}â€¢_while_(ğ•©>âŠ‘)âŸ¨0,Ref lâŸ©} â€¢_timed updates
!âŸœ((start_length+updates)âŠ¸â‰¡) â‰ l

l â†© start_lengthâ†‘Ï€
"-._update2" util.Debug {l â†© {ğ•©.ref}1âŠ‘{câ€¿w : âˆ¾âŸœÏ€ w._update2 @ â‹„ âŸ¨c+1,wâŸ©}â€¢_while_(ğ•©>âŠ‘)âŸ¨0,Ref lâŸ©} â€¢_timed updates
!âŸœ((start_length+updates)âŠ¸â‰¡) â‰ l

l â†© start_lengthâ†‘Ï€
"-._update3" util.Debug {l â†© {ğ•©.ref}1âŠ‘{câ€¿w : âˆ¾ w._update3 Ï€ â‹„ âŸ¨c+1,wâŸ©}â€¢_while_(ğ•©>âŠ‘)âŸ¨0,Ref lâŸ©} â€¢_timed updates
!âŸœ((start_length+updates)âŠ¸â‰¡) â‰ l

m â† Longlist 100000
{m.Add Ï€ â‹„ ğ•©+1}â€¢_while_(start_lengthâŠ¸>)0
!âŸœ(start_lengthâŠ¸â‰¡) m.Size@
"indirect -" util.Debug {m â†© 1âŠ‘{câ€¿m : m.Add Ï€ â‹„ âŸ¨c+1,mâŸ©}â€¢_while_(ğ•©>âŠ‘)0â€¿m} â€¢_timed updates
!âŸœ((start_length+updates)âŠ¸â‰¡) m.Size@

#  - update lst: 6.697469000000001
#  - in-place -: 0.0014390000000000002
#  - update arg: 6.643209000000001
#  - in-place -: 6.647899000000001
#  - in-place 2: 6.660026
#  - wrap in ns: 0.0029370000000000004
#  - indirect -: 0.002893

# $ cbqn benchmark/ref.bqn to add Ref._apply
#  - init/add:   âŸ¨ 1000000 10000 âŸ©
#  - update lst: 2.484448
#  - in-place -: 0.00064
#  - update arg: 2.496944
#  - in-place -: 2.497812
#  - in-place 2: 2.493621
#  - Ref.append: 0.00117
#  - -.update1:  0.0014800000000000002
#  - -._update2: 0.0013770000000000002
#  - -._update3: 0.001108
#  - indirect -: 0.0015190000000000002
